#!/bin/bash
set -euo pipefail

# -----------------------------
# Configuration
# -----------------------------
VOLUMES_DIR="/volumes"
CODE_DIR="$VOLUMES_DIR/code-server"
COMPOSE_DIR="$VOLUMES_DIR/code-server-docker"
COMPOSE_FILE="$COMPOSE_DIR/docker-compose.yml"
ENV_FILE="$COMPOSE_DIR/.env"
CODE_PORT=8080  # local fallback port

# Traefik settings
TRAEFIK_NETWORK="traefik-net"
TRAEFIK_HOST="code.faithlink.io"  # change to your domain

# -----------------------------
# Helper function for errors
# -----------------------------
fatal() {
    echo "Error: $*" >&2
    exit 1
}

# -----------------------------
# Step 1: Create directories
# -----------------------------
mkdir -p "$CODE_DIR" || fatal "Failed to create workspace dir $CODE_DIR"
mkdir -p "$COMPOSE_DIR" || fatal "Failed to create compose dir $COMPOSE_DIR"

# -----------------------------
# Step 2: Ensure .env file exists
# -----------------------------
if [[ ! -f "$ENV_FILE" ]]; then
    echo "CODE_SERVER_PASSWORD=changeme" > "$ENV_FILE"
    echo "Created .env file with default password. Please edit $ENV_FILE"
fi

# -----------------------------
# Step 3: Create docker-compose.yml
# -----------------------------
cat > "$COMPOSE_FILE" <<EOF

services:
  code-server:
    image: linuxserver/code-server:latest
    container_name: code-server
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Europe/London
      - PASSWORD_FILE=/config/.env
    volumes:
      - ./code-server:/config
      - /var/run/docker.sock:/var/run/docker.sock
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.code-server.rule=Host(`code.faithlink.io`)"
      - "traefik.http.routers.code-server.entrypoints=websecure"
      - "traefik.http.routers.code-server.tls.certresolver=letsencrypt"
      - "traefik.http.services.code-server.loadbalancer.server.port=8443"
    networks:
      - traefik-net
    restart: unless-stopped

networks:
  traefik-net:
    external: true

EOF

# -----------------------------
# Step 4: Launch code-server
# -----------------------------
docker compose -f "$COMPOSE_FILE" down
docker compose -f "$COMPOSE_FILE" up -d || fatal "Failed to start code-server"

echo "âœ… code-server is running!"
echo "Workspace mounted at: $CODE_DIR"
echo "Access via Traefik: https://${TRAEFIK_HOST}"
echo "Local fallback: http://localhost:${CODE_PORT}"
echo "Edit your password in $ENV_FILE"
