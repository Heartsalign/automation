#!/bin/bash
set -euo pipefail

# -----------------------------
# Configuration
# -----------------------------
REGISTRY_DIR="/bootstrap/registry"
VOLUMES_DIR="/volumes"
REGISTRY_DATA_DIR="$VOLUMES_DIR/registry"
AUTH_DIR="$REGISTRY_DATA_DIR/auth"
COMPOSE_FILE="$REGISTRY_DIR/docker-compose.yml"

TRAEFIK_HOST="registry.faithlink.io"

# -----------------------------
# Helper for error handling
# -----------------------------
fatal() {
  echo "‚ùå Error: $*" >&2
  exit 1
}

# -----------------------------
# Step 1: Create directory structure
# -----------------------------
echo "üìÅ Creating directory structure..."
sudo mkdir -p "$REGISTRY_DIR" "$AUTH_DIR" "$REGISTRY_DATA_DIR/registry" || fatal "Failed to create registry directories"
cd "$REGISTRY_DIR" || fatal "Failed to cd into $REGISTRY_DIR"

# -----------------------------
# Step 2: Get username and password interactively
# -----------------------------
read -p "Enter registry username [docker]: " USERNAME
USERNAME=${USERNAME:-docker}

read -s -p "Enter registry password [docker-pass]: " PASSWORD
PASSWORD=${PASSWORD:-docker-pass}
echo

# -----------------------------
# Step 3: Create htpasswd file
# -----------------------------
echo "üîê Creating htpasswd file for user '$USERNAME'..."
sudo docker run --rm --entrypoint htpasswd httpd:2 -Bbn "$USERNAME" "$PASSWORD" > "$AUTH_DIR/htpasswd"
echo "‚úÖ Authentication file created at $AUTH_DIR/htpasswd"

# -----------------------------
# Step 4: Create docker-compose.yml
# -----------------------------
echo "üìù Writing $COMPOSE_FILE..."
sudo tee "$COMPOSE_FILE" > /dev/null <<EOF
services:
  registry-server:
    image: registry:2
    container_name: registry-server
    restart: always
    environment:
      REGISTRY_AUTH: htpasswd
      REGISTRY_AUTH_HTPASSWD_PATH: /auth/htpasswd
      REGISTRY_AUTH_HTPASSWD_REALM: Registry Realm
    volumes:
      - $AUTH_DIR:/auth
      - $REGISTRY_DATA_DIR/registry:/var/lib/registry
    labels:
      - "traefik.enable=true"

      # HTTPS router
      - "traefik.http.routers.registry.rule=Host(`secure.${TRAEFIK_HOST}`)"
      - "traefik.http.routers.registry.entrypoints=websecure"
      - "traefik.http.routers.registry.tls.certresolver=letsencrypt"
      - "traefik.http.services.registry.loadbalancer.server.port=5000"

      # HTTP router (web) restricted to portainer
      - "traefik.http.routers.registry-http.rule=Host(`${TRAEFIK_HOST}`)"
      - "traefik.http.routers.registry-http.entrypoints=web"
      - "traefik.http.services.registry-http.loadbalancer.server.port=5000"

    networks:
      - traefik-net

networks:
  traefik-net:
    external: true
EOF

# -----------------------------
# Step 5: Start registry
# -----------------------------
echo "üöÄ Starting Docker Registry with Traefik integration..."
sudo docker compose -f "$COMPOSE_FILE" down >/dev/null 2>&1 || true
sudo docker compose -f "$COMPOSE_FILE" up -d || fatal "Failed to start registry"

# -----------------------------
# Done
# -----------------------------
echo "‚úÖ Docker Registry setup complete!"
echo
echo "üì¶ Registry Info:"
echo "  URL: https://${TRAEFIK_HOST}"
echo "  Username: $USERNAME"
echo "  Password: $PASSWORD"
echo
echo "üìÅ Files located at: $REGISTRY_DIR"
