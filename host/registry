#!/bin/bash
set -euo pipefail

# -----------------------------
# Configuration
# -----------------------------
REGISTRY_DIR="/bootstrap/registry"
VOLUMES_DIR="/volumes"
REGISTRY_DATA_DIR="$VOLUMES_DIR/registry"
AUTH_DIR="$REGISTRY_DATA_DIR/auth"
COMPOSE_FILE="$REGISTRY_DIR/docker-compose.yml"

TRAEFIK_HOST="registry.faithlink.io"

# -----------------------------
# Helper for error handling
# -----------------------------
fatal() {
  echo "‚ùå Error: $*" >&2
  exit 1
}

# -----------------------------
# Step 1: Create directory structure
# -----------------------------
echo "üìÅ Creating directory structure..."
# Using -p is good, adding the check after the command for robustness
if ! sudo mkdir -p "$REGISTRY_DIR" "$AUTH_DIR" "$REGISTRY_DATA_DIR/registry"; then
  fatal "Failed to create registry directories"
fi
cd "$REGISTRY_DIR" || fatal "Failed to cd into $REGISTRY_DIR"

# -----------------------------
# Step 2: Get username and password interactively
# -----------------------------
read -p "Enter registry username [docker]: " USERNAME
USERNAME=${USERNAME:-docker}

read -s -p "Enter registry password [docker-pass]: " PASSWORD
PASSWORD=${PASSWORD:-docker-pass}
echo

# -----------------------------
# Step 3: Create htpasswd file
# -----------------------------
echo "üîê Creating htpasswd file for user '$USERNAME'..."
# The original command is fine. Adding the check for the file existence is a minor safety enhancement.
if ! sudo docker run --rm --entrypoint htpasswd httpd:2 -Bbn "$USERNAME" "$PASSWORD" > "$AUTH_DIR/htpasswd"; then
  fatal "Failed to generate htpasswd file"
fi
echo "‚úÖ Authentication file created at $AUTH_DIR/htpasswd"

# -----------------------------
# Step 4: Create docker-compose.yml
# -----------------------------
echo "üìù Writing $COMPOSE_FILE..."
# FIX: Adjusted Traefik labels for HTTPS (websecure) and added basic auth middleware.
# FIX: Added a service port (5000) for internal communication, though not strictly required when only using Traefik.
sudo tee "$COMPOSE_FILE" > /dev/null <<EOF
services:
  registry-server:
    image: registry:2
    container_name: registry-server
    restart: always
    # Explicitly map the internal port for clarity, though Traefik connects directly via the network
    ports:
      - "5000:5000" 
    environment:
      REGISTRY_AUTH: htpasswd
      REGISTRY_AUTH_HTPASSWD_PATH: /auth/htpasswd
      REGISTRY_AUTH_HTPASSWD_REALM: Registry Realm
      # Allow-Origin header should typically be the domain the browser will access
      REGISTRY_HTTP_HEADERS_Access-Control-Allow-Origin: '[https://${TRAEFIK_HOST}]' 
      REGISTRY_HTTP_HEADERS_Access-Control-Allow-Methods: '[HEAD,GET,OPTIONS,DELETE]'
      REGISTRY_HTTP_HEADERS_Access-Control-Allow-Credentials: '[true]'
      REGISTRY_HTTP_HEADERS_Access-Control-Allow-Headers: '[Authorization,Accept,Cache-Control]'
      REGISTRY_HTTP_HEADERS_Access-Control-Expose-Headers: '[Docker-Content-Digest]'
      REGISTRY_STORAGE_DELETE_ENABLED: 'true'

    volumes:
      - $AUTH_DIR:/auth
      - $REGISTRY_DATA_DIR/registry:/var/lib/registry
    labels:
      - "traefik.enable=true"

      - "traefik.http.routers.registry-https.rule=Host(\`${TRAEFIK_HOST}\`)"
      - "traefik.http.routers.registry-https.entrypoints=websecure"
      - "traefik.http.routers.registry-https.tls=true"
      - "traefik.http.services.registry-service.loadbalancer.server.port=5000"

    networks:
      - traefik-net

networks:
  traefik-net:
    external: true
EOF

# -----------------------------
# Step 5: Start registry
# -----------------------------
echo "üöÄ Starting Docker Registry with Traefik integration..."
# Use 'down -v' to clean up anonymous volumes if needed, but 'down' is usually safer.
sudo docker compose -f "$COMPOSE_FILE" down >/dev/null 2>&1 || true
sudo docker compose -f "$COMPOSE_FILE" up -d || fatal "Failed to start registry"

# -----------------------------
# Done
# -----------------------------
echo "‚úÖ Docker Registry setup complete!"
echo
echo "üì¶ Registry Info:"
echo "  URL: https://${TRAEFIK_HOST}"
echo "  Username: $USERNAME"
echo "  Password: $PASSWORD"
echo
echo "üìÅ Files located at: $REGISTRY_DIR"